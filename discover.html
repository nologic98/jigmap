<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Discovery Map Demo</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      body { margin: 0; padding: 0; background: #f8faf8; color: #1B4332; }
      #map { position: absolute; top: 36px; bottom: 0; width: 100%; }
      .mapboxgl-ctrl-logo, .mapboxgl-ctrl-attrib { display: none !important; }

      /* Nav header */
      .nav-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 36px;
        background: #ffffff;
        border-bottom: 1px solid #e2e8e4;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        z-index: 100;
        font-size: 12px;
      }
      .nav-brand {
        color: #1B4332;
        font-weight: 600;
      }
      .nav-links {
        display: flex;
        gap: 4px;
      }
      .nav-links a {
        padding: 4px 10px;
        border-radius: 4px;
        text-decoration: none;
        color: #5c7c6a;
        transition: color 0.15s, background 0.15s;
      }
      .nav-links a:hover {
        color: #1B4332;
        background: rgba(27, 67, 50, 0.08);
      }
      .nav-links a.active {
        color: #1B4332;
        font-weight: 600;
      }

      /* Control panel */
      .control-panel {
        position: absolute;
        bottom: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #e2e8e4;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        backdrop-filter: blur(12px);
        box-shadow: 0 4px 20px rgba(27, 67, 50, 0.12);
        display: flex;
        gap: 0.75rem;
        align-items: center;
        z-index: 10;
      }
      .control-panel button {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 1px solid #d1d9d4;
        background: #ffffff;
        color: #1B4332;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
      }
      .control-panel button:hover {
        background: rgba(45, 106, 79, 0.1);
        border-color: #2D6A4F;
        color: #2D6A4F;
      }
      .control-panel button.active {
        background: rgba(45, 106, 79, 0.15);
        border-color: #2D6A4F;
        color: #2D6A4F;
      }
      .control-panel button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .stats {
        font-size: 0.8rem;
        color: #5c7c6a;
        padding: 0 0.5rem;
        border-left: 1px solid #e2e8e4;
      }
      .stats strong {
        color: #2D6A4F;
      }

      /* Mobile adjustments */
      @media (max-width: 480px) {
        .control-panel {
          bottom: 1rem;
          padding: 0.5rem 0.75rem;
          gap: 0.5rem;
          flex-wrap: wrap;
          justify-content: center;
          max-width: calc(100% - 2rem);
        }
        .control-panel button {
          padding: 0.4rem 0.75rem;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="nav-header">
      <div class="nav-brand">TalkTravel Maps</div>
      <nav class="nav-links">
        <a href="jigsaw.html">Jigsaw</a>
        <a href="routes.html">Routes</a>
        <a href="discover.html" class="active">Discover</a>
      </nav>
    </header>
    <div id="map"></div>
    <div class="control-panel">
      <button id="btn-simulate">Simulate Discovery</button>
      <button id="btn-reset">Reset</button>
      <div class="stats">Discovered: <strong id="count">0</strong></div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiZGttaWNoYWVscyIsImEiOiJjbWlnczV6bnQwYjlxM2Nvb2U2YjNseWxoIn0.bG5oBDdzT3coIAlUDk8fxA';

      // Home location (San Francisco)
      const HOME = { name: 'San Francisco', lon: -122.419, lat: 37.775, country: 'USA' };

      // Country centroids (approximate) for route destinations
      const countryCentroids = {
        USA: { lon: -98.5, lat: 39.8 },
        CAN: { lon: -106.3, lat: 56.1 },
        MEX: { lon: -102.5, lat: 23.6 },
        BRA: { lon: -51.9, lat: -14.2 },
        ARG: { lon: -63.6, lat: -38.4 },
        GBR: { lon: -3.4, lat: 55.4 },
        FRA: { lon: 2.2, lat: 46.2 },
        DEU: { lon: 10.5, lat: 51.2 },
        ITA: { lon: 12.6, lat: 41.9 },
        ESP: { lon: -3.7, lat: 40.5 },
        PRT: { lon: -8.2, lat: 39.4 },
        NLD: { lon: 5.3, lat: 52.1 },
        CHE: { lon: 8.2, lat: 46.8 },
        AUT: { lon: 14.6, lat: 47.5 },
        SWE: { lon: 18.6, lat: 60.1 },
        NOR: { lon: 8.5, lat: 60.5 },
        DNK: { lon: 9.5, lat: 56.3 },
        FIN: { lon: 26.0, lat: 61.9 },
        POL: { lon: 19.1, lat: 51.9 },
        CZE: { lon: 15.5, lat: 49.8 },
        GRC: { lon: 21.8, lat: 39.1 },
        TUR: { lon: 35.2, lat: 39.0 },
        RUS: { lon: 105.3, lat: 61.5 },
        CHN: { lon: 104.2, lat: 35.9 },
        JPN: { lon: 138.3, lat: 36.2 },
        KOR: { lon: 127.8, lat: 35.9 },
        IND: { lon: 78.9, lat: 20.6 },
        THA: { lon: 100.5, lat: 15.9 },
        VNM: { lon: 108.3, lat: 14.1 },
        IDN: { lon: 113.9, lat: -0.8 },
        PHL: { lon: 121.8, lat: 12.9 },
        AUS: { lon: 133.8, lat: -25.3 },
        NZL: { lon: 174.9, lat: -40.9 },
        ZAF: { lon: 22.9, lat: -30.6 },
        EGY: { lon: 30.8, lat: 26.8 },
        MAR: { lon: -7.1, lat: 31.8 },
        KEN: { lon: 38.0, lat: -0.0 },
        NGA: { lon: 8.7, lat: 9.1 },
        ISR: { lon: 34.9, lat: 31.0 },
        ARE: { lon: 53.8, lat: 23.4 },
        SGP: { lon: 103.8, lat: 1.4 },
        MYS: { lon: 101.9, lat: 4.2 },
        CHL: { lon: -71.5, lat: -35.7 },
        COL: { lon: -74.3, lat: 4.6 },
        PER: { lon: -75.0, lat: -9.2 },
        IRL: { lon: -8.2, lat: 53.1 },
        ISL: { lon: -19.0, lat: 65.0 },
        HRV: { lon: 15.2, lat: 45.1 },
        HUN: { lon: 19.5, lat: 47.2 },
      };

      // Regional groupings for branching routes
      const regions = {
        northAmerica: ['USA', 'CAN', 'MEX'],
        southAmerica: ['BRA', 'ARG', 'CHL', 'COL', 'PER'],
        westernEurope: ['GBR', 'FRA', 'ESP', 'PRT', 'IRL', 'NLD', 'DEU', 'CHE', 'AUT'],
        southernEurope: ['ITA', 'GRC', 'HRV'],
        northernEurope: ['SWE', 'NOR', 'DNK', 'FIN', 'ISL'],
        easternEurope: ['POL', 'CZE', 'HUN', 'TUR'],
        middleEast: ['ISR', 'ARE', 'EGY'],
        africa: ['MAR', 'KEN', 'NGA', 'ZAF'],
        southAsia: ['IND'],
        southeastAsia: ['THA', 'VNM', 'SGP', 'MYS', 'IDN', 'PHL'],
        eastAsia: ['CHN', 'JPN', 'KOR'],
        oceania: ['AUS', 'NZL'],
      };

      // Map country to region
      const countryToRegion = {};
      Object.entries(regions).forEach(([region, countries]) => {
        countries.forEach(c => countryToRegion[c] = region);
      });

      // Track regional hubs (first visited country in each region)
      let regionalHubs = {};

      // Simulation with regional branching - each entry is { country, fromRegional: bool }
      // First country in a region comes from home, subsequent ones branch from previous
      const simulationTrips = [
        // Trip 1: Mexico quick trip
        { country: 'MEX', fromHome: true },
        // Trip 2: South America adventure
        { country: 'BRA', fromHome: true },
        { country: 'ARG', fromPrev: true },
        { country: 'CHL', fromPrev: true },
        // Trip 3: Western Europe
        { country: 'GBR', fromHome: true },
        { country: 'FRA', fromPrev: true },
        { country: 'ESP', fromPrev: true },
        { country: 'PRT', fromPrev: true },
        // Trip 4: Central/Southern Europe
        { country: 'ITA', fromHome: true },
        { country: 'CHE', fromPrev: true },
        { country: 'AUT', fromPrev: true },
        { country: 'HRV', fromPrev: true },
        { country: 'GRC', fromPrev: true },
        // Trip 5: Southeast Asia
        { country: 'THA', fromHome: true },
        { country: 'VNM', fromPrev: true },
        { country: 'SGP', fromPrev: true },
        { country: 'IDN', fromPrev: true },
        // Trip 6: East Asia
        { country: 'JPN', fromHome: true },
        { country: 'KOR', fromPrev: true },
        { country: 'CHN', fromPrev: true },
        // Trip 7: Oceania
        { country: 'AUS', fromHome: true },
        { country: 'NZL', fromPrev: true },
        // Trip 8: Middle East & Africa
        { country: 'ARE', fromHome: true },
        { country: 'EGY', fromPrev: true },
        { country: 'KEN', fromPrev: true },
        { country: 'ZAF', fromPrev: true },
      ];

      const COUNTRY_PROP = 'iso_3166_1_alpha_3';

      // State
      let discovered = new Set(['USA']); // Start with home country
      let routes = []; // Array of route objects { from, to, progress, isRegional }
      let isSimulating = false;
      let simulationIndex = 0;
      let animationFrame = null;
      let lastVisitedCountry = null; // Track for regional branching

      const isMobile = window.innerWidth <= 480;

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [HOME.lon, HOME.lat],
        zoom: isMobile ? 2 : 3,
      });

      // Color palette
      const palette = {
        active: '#2D6A4F',
        accent: '#40916C',
        neutral: '#d8e2dc',
        border: '#b7c9bc',
        glow: '#52B788',
        route: '#2D6A4F',
        routeDim: '#95D5B2',
      };

      // Expressions for country styling
      const highlightCondition = () => [
        'in', ['get', COUNTRY_PROP], ['literal', Array.from(discovered)]
      ];

      const makeFillColor = () => ['case', highlightCondition(), palette.active, palette.neutral];
      const makeFillOpacity = () => ['case', highlightCondition(), 0.85, 0.3];
      const makeOutline = () => ['case', highlightCondition(), palette.accent, palette.border];
      const makeGlow = () => ['case', highlightCondition(), palette.glow, 'rgba(0,0,0,0)'];

      function refreshCountryStyling() {
        if (!map.getLayer('country-fills')) return;
        map.setPaintProperty('country-fills', 'fill-color', makeFillColor());
        map.setPaintProperty('country-fills', 'fill-opacity', makeFillOpacity());
        map.setPaintProperty('country-fills', 'fill-outline-color', makeOutline());
        map.setPaintProperty('country-glow', 'line-color', makeGlow());
        updateStats();
      }

      function updateStats() {
        document.getElementById('count').textContent = discovered.size;
      }

      // Build animated route GeoJSON
      function buildRoutesGeoJSON() {
        const features = [];
        routes.forEach((route, idx) => {
          if (route.progress <= 0) return;

          const start = [route.from.lon, route.from.lat];
          const end = [route.to.lon, route.to.lat];
          const fullArc = turf.greatCircle(start, end, { npoints: 100 });

          // Slice the arc based on progress (0-1)
          const coords = fullArc.geometry.coordinates;
          const sliceEnd = Math.floor(coords.length * route.progress);
          if (sliceEnd < 2) return;

          features.push({
            type: 'Feature',
            geometry: {
              type: 'LineString',
              coordinates: coords.slice(0, sliceEnd),
            },
            properties: {
              index: idx,
              complete: route.progress >= 1,
              isRegional: route.isRegional || false,
            },
          });
        });
        return { type: 'FeatureCollection', features };
      }

      // Animate a single route
      function animateRoute(countryCode, fromLocation, isRegional, onComplete) {
        const centroid = countryCentroids[countryCode];
        if (!centroid) {
          if (onComplete) onComplete();
          return;
        }

        const from = fromLocation || HOME;
        const route = { from, to: centroid, country: countryCode, progress: 0, isRegional };
        routes.push(route);
        const routeIndex = routes.length - 1;

        // Calculate bounds for camera
        const bounds = new mapboxgl.LngLatBounds();
        bounds.extend([from.lon, from.lat]);
        bounds.extend([centroid.lon, centroid.lat]);

        // For regional routes, zoom in more; for home routes, show wider view
        const maxZoom = isRegional ? 4 : 5;
        const padding = isRegional ? (isMobile ? 80 : 120) : (isMobile ? 60 : 100);

        // Fly to show the route
        map.fitBounds(bounds, {
          padding,
          duration: isRegional ? 1200 : 1500,
          maxZoom,
        });

        // Animate the line drawing (regional routes animate faster)
        const duration = isRegional ? 800 : 1200;
        const startTime = performance.now();

        function animate(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // Easing function for smooth animation
          routes[routeIndex].progress = easeOutCubic(progress);

          // Update the routes source
          const source = map.getSource('routes');
          if (source) {
            source.setData(buildRoutesGeoJSON());
          }

          if (progress < 1) {
            animationFrame = requestAnimationFrame(animate);
          } else {
            // Animation complete - mark country as discovered
            discovered.add(countryCode);
            lastVisitedCountry = countryCode;
            refreshCountryStyling();
            if (onComplete) onComplete();
          }
        }

        animationFrame = requestAnimationFrame(animate);
      }

      function easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
      }

      // Discover a country (click or simulation)
      function discoverCountry(countryCode, fromPrev = false) {
        if (discovered.has(countryCode)) return;
        if (!countryCentroids[countryCode]) {
          // Country not in our list, just highlight it
          discovered.add(countryCode);
          refreshCountryStyling();
          return;
        }

        // Determine origin: from previous country or from home
        let fromLocation = HOME;
        let isRegional = false;

        if (fromPrev && lastVisitedCountry && countryCentroids[lastVisitedCountry]) {
          fromLocation = countryCentroids[lastVisitedCountry];
          isRegional = true;
        }

        animateRoute(countryCode, fromLocation, isRegional);
      }

      // Run simulation with branching trips
      function runSimulation() {
        if (simulationIndex >= simulationTrips.length) {
          stopSimulation();
          // Zoom out to show the full network
          setTimeout(() => {
            map.flyTo({
              center: [0, 20],
              zoom: isMobile ? 0.8 : 1.5,
              duration: 2000,
            });
          }, 500);
          return;
        }

        const trip = simulationTrips[simulationIndex];
        simulationIndex++;

        if (discovered.has(trip.country)) {
          // Skip already discovered, continue immediately
          setTimeout(runSimulation, 100);
          return;
        }

        // Determine origin
        let fromLocation = HOME;
        let isRegional = false;

        if (trip.fromPrev && lastVisitedCountry && countryCentroids[lastVisitedCountry]) {
          fromLocation = countryCentroids[lastVisitedCountry];
          isRegional = true;
        }

        animateRoute(trip.country, fromLocation, isRegional, () => {
          if (isSimulating) {
            // Shorter delay for regional hops, longer for new trips from home
            const delay = isRegional ? 500 : 800;
            setTimeout(runSimulation, delay);
          }
        });
      }

      function startSimulation() {
        if (isSimulating) return;
        isSimulating = true;
        document.getElementById('btn-simulate').classList.add('active');
        document.getElementById('btn-simulate').textContent = 'Simulating...';
        runSimulation();
      }

      function stopSimulation() {
        isSimulating = false;
        document.getElementById('btn-simulate').classList.remove('active');
        document.getElementById('btn-simulate').textContent = 'Simulate Discovery';
      }

      function reset() {
        stopSimulation();
        if (animationFrame) cancelAnimationFrame(animationFrame);

        discovered = new Set(['USA']);
        routes = [];
        simulationIndex = 0;
        lastVisitedCountry = null;
        regionalHubs = {};

        const source = map.getSource('routes');
        if (source) {
          source.setData({ type: 'FeatureCollection', features: [] });
        }

        refreshCountryStyling();

        map.flyTo({
          center: [HOME.lon, HOME.lat],
          zoom: isMobile ? 2 : 3,
          duration: 1000,
        });
      }

      // Initialize map
      map.on('load', () => {
        // Country boundaries source
        map.addSource('countries', {
          type: 'vector',
          url: 'mapbox://mapbox.country-boundaries-v1',
        });

        // Country fill layer
        map.addLayer({
          id: 'country-fills',
          type: 'fill',
          source: 'countries',
          'source-layer': 'country_boundaries',
          paint: {
            'fill-color': makeFillColor(),
            'fill-opacity': makeFillOpacity(),
            'fill-outline-color': makeOutline(),
          },
        });

        // Country borders
        map.addLayer({
          id: 'country-borders',
          type: 'line',
          source: 'countries',
          'source-layer': 'country_boundaries',
          paint: {
            'line-color': '#a8b5ab',
            'line-width': 0.5,
          },
        });

        // Country glow for discovered
        map.addLayer({
          id: 'country-glow',
          type: 'line',
          source: 'countries',
          'source-layer': 'country_boundaries',
          paint: {
            'line-color': makeGlow(),
            'line-width': 4,
            'line-blur': 2,
            'line-opacity': 0.35,
          },
        });

        // Routes source and layer
        map.addSource('routes', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: [] },
        });

        map.addLayer({
          id: 'route-lines',
          type: 'line',
          source: 'routes',
          paint: {
            // Regional routes are lighter/thinner than home routes
            'line-color': [
              'case',
              ['get', 'isRegional'],
              palette.routeDim,  // lighter green for regional
              palette.route,     // darker green for home routes
            ],
            'line-width': [
              'interpolate', ['linear'], ['zoom'],
              1, ['case', ['get', 'isRegional'], 1.5, 2.5],
              5, ['case', ['get', 'isRegional'], 2.5, 4],
            ],
            'line-opacity': ['case', ['get', 'isRegional'], 0.75, 0.9],
          },
          layout: {
            'line-cap': 'round',
            'line-join': 'round',
          },
        });

        // Home marker
        map.addSource('home', {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [HOME.lon, HOME.lat] },
            properties: { name: HOME.name },
          },
        });

        map.addLayer({
          id: 'home-point',
          type: 'circle',
          source: 'home',
          paint: {
            'circle-radius': 8,
            'circle-color': '#1B4332',
            'circle-stroke-color': '#52B788',
            'circle-stroke-width': 3,
          },
        });

        map.addLayer({
          id: 'home-pulse',
          type: 'circle',
          source: 'home',
          paint: {
            'circle-radius': 20,
            'circle-color': 'transparent',
            'circle-stroke-color': '#2D6A4F',
            'circle-stroke-width': 2,
            'circle-opacity': 0.4,
          },
        });

        // Click to discover countries
        map.on('click', 'country-fills', (e) => {
          if (isSimulating) return;
          const feature = e.features[0];
          const iso = feature.properties[COUNTRY_PROP];
          if (iso && iso !== 'USA') {
            discoverCountry(iso);
          }
        });

        map.on('mouseenter', 'country-fills', () => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'country-fills', () => {
          map.getCanvas().style.cursor = '';
        });

        updateStats();
      });

      // Button handlers
      document.getElementById('btn-simulate').addEventListener('click', () => {
        if (isSimulating) {
          stopSimulation();
        } else {
          startSimulation();
        }
      });

      document.getElementById('btn-reset').addEventListener('click', reset);
    </script>
  </body>
</html>
