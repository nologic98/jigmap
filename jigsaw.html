<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>TalkTravel Jigsaw Map Demo</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      * { box-sizing: border-box; }
      body { margin: 0; padding: 0; background: #020617; color: #e2e8f0; overflow: hidden; }
      #map { position: fixed; top: 36px; left: 0; right: 0; bottom: 0; }

      /* Nav header */
      .nav-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 36px;
        background: rgba(2, 6, 23, 0.95);
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        z-index: 100;
        font-size: 12px;
      }
      .nav-brand {
        color: #94a3b8;
        font-weight: 500;
      }
      .nav-links {
        display: flex;
        gap: 4px;
      }
      .nav-links a {
        padding: 4px 10px;
        border-radius: 4px;
        text-decoration: none;
        color: #64748b;
        transition: color 0.15s, background 0.15s;
      }
      .nav-links a:hover {
        color: #e2e8f0;
        background: rgba(148, 163, 184, 0.1);
      }
      .nav-links a.active {
        color: #f4b98d;
      }
      .mapboxgl-ctrl-logo, .mapboxgl-ctrl-attrib { display: none !important; }

      /* ───────────────────────────────────────────────────────────────
         UI PANEL – fixed, compact, never grows beyond set bounds
      ─────────────────────────────────────────────────────────────── */
      .ui-panel {
        position: fixed;
        top: 48px;
        left: 12px;
        width: 260px;
        max-height: calc(100vh - 24px);
        background: rgba(2, 6, 23, 0.88);
        border: 1px solid rgba(148, 163, 184, 0.18);
        border-radius: 14px;
        padding: 10px 12px;
        backdrop-filter: blur(14px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.45);
        z-index: 10;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .hover-readout {
        font-size: 0.95rem;
        font-weight: 600;
        color: #f8fafc;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 0;
        margin-bottom: 8px;
      }
      .search-block {
        position: relative;
        flex-shrink: 0;
        margin-bottom: 8px;
      }
      .search-block input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.7);
        color: #f1f5f9;
        font-size: 0.85rem;
      }
      .search-block input:focus {
        outline: none;
        border-color: #f4b98d;
        box-shadow: 0 0 0 2px rgba(244, 185, 141, 0.25);
      }
      .suggestions {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 4px;
        max-height: 150px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.95);
        z-index: 20;
      }
      .suggestion {
        padding: 6px 10px;
        cursor: pointer;
        font-size: 0.8rem;
        color: #e2e8f0;
      }
      .suggestion:hover {
        background: rgba(244, 185, 141, 0.2);
      }
      .selection-block {
        flex: 1 1 auto;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .selection-block h2 {
        margin: 0 0 6px;
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: #64748b;
        flex-shrink: 0;
      }
      .selection-block ul {
        list-style: none;
        margin: 0;
        padding: 0;
        overflow-y: auto;
        flex: 1 1 auto;
      }
      .selection-block li {
        padding: 4px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        font-size: 0.8rem;
        color: #cbd5e1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .selection-block li span {
        color: #475569;
        font-size: 0.7rem;
      }
      .selection-block li:last-child {
        border-bottom: none;
      }
      .empty-state {
        font-size: 0.8rem;
        color: #64748b;
      }

      /* ───────────────────────────────────────────────────────────────
         MOBILE: bottom sheet, collapsed by default
      ─────────────────────────────────────────────────────────────── */
      @media (max-width: 600px) {
        .ui-panel {
          top: auto;
          left: 8px;
          right: 8px;
          bottom: 8px;
          width: auto;
          max-height: 44vh;
          border-radius: 16px;
          padding: 8px 10px 10px;
        }
        .ui-panel.collapsed {
          max-height: 42px;
          padding: 6px 10px;
        }
        .ui-panel.collapsed .panel-body {
          display: none;
        }
        .panel-toggle {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          background: rgba(244, 185, 141, 0.12);
          color: #f4b98d;
          border: none;
          border-radius: 8px;
          padding: 6px 10px;
          font-size: 0.75rem;
          font-weight: 600;
          letter-spacing: 0.04em;
          text-transform: uppercase;
          cursor: pointer;
          flex-shrink: 0;
        }
        .panel-toggle:focus {
          outline: none;
          box-shadow: 0 0 0 2px rgba(244, 185, 141, 0.3);
        }
        .panel-body {
          display: flex;
          flex-direction: column;
          flex: 1 1 auto;
          min-height: 0;
          margin-top: 8px;
        }
      }
      @media (min-width: 601px) {
        .panel-toggle { display: none; }
        .panel-body {
          display: contents;
        }
      }
    </style>
  </head>
  <body>
    <header class="nav-header">
      <div class="nav-brand">TalkTravel Maps</div>
      <nav class="nav-links">
        <a href="jigsaw.html" class="active">Jigsaw</a>
        <a href="routes.html">Routes</a>
        <a href="discover.html">Discover</a>
      </nav>
    </header>
    <div id="map"></div>

    <div class="ui-panel" id="ui-panel">
      <button class="panel-toggle" id="panel-toggle" type="button" aria-expanded="false">
        <span class="toggle-label">Show tools</span>
      </button>
      <div class="panel-body" id="panel-body">
        <div class="hover-readout" id="hover-readout">Tap a country</div>
        <div class="search-block">
          <input id="country-search" type="text" placeholder="Search country..." autocomplete="off" />
          <div class="suggestions" id="search-suggestions"></div>
        </div>
        <div class="selection-block">
          <h2>Selected</h2>
          <ul id="selection-list"></ul>
        </div>
      </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiZGttaWNoYWVscyIsImEiOiJjbWlnczV6bnQwYjlxM2Nvb2U2YjNseWxoIn0.bG5oBDdzT3coIAlUDk8fxA';

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [0, 25],
        zoom: 1.4
      });

      const panelEl = document.getElementById('ui-panel');
      const panelToggleEl = document.getElementById('panel-toggle');
      const hoverReadoutEl = document.getElementById('hover-readout');
      const selectionListEl = document.getElementById('selection-list');
      const searchInputEl = document.getElementById('country-search');
      const suggestionsEl = document.getElementById('search-suggestions');

      const philPalette = {
        active: '#f4b98d',
        accent: '#ffe7c2',
        neutral: '#020617',
        border: '#0f172a',
        glow: '#fcd7a5'
      };

      const COUNTRY_PROP = 'iso_3166_1_alpha_3';

      let highlighted = new Set(['USA', 'FRA', 'JPN', 'THA']);
      let mapReady = false;
      let hoveredIso = null;
      let countryDirectory = [];
      const countryLookup = {};
      const fallbackNames = {};
      let currentSuggestions = [];
      const isoColorCache = {};
      const mobileMedia = window.matchMedia('(max-width: 600px)');
      let panelCollapsed = mobileMedia.matches;

      const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));

      const hexToHsl = (hex) => {
        const n = parseInt(hex.replace('#', ''), 16);
        const r = ((n >> 16) & 255) / 255;
        const g = ((n >> 8) & 255) / 255;
        const b = (n & 255) / 255;
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h = 0, s = 0;
        const l = (max + min) / 2;
        if (max !== min) {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          if (max === r) h = (g - b) / d + (g < b ? 6 : 0);
          else if (max === g) h = (b - r) / d + 2;
          else h = (r - g) / d + 4;
          h /= 6;
        }
        return { h: h * 360, s: s * 100, l: l * 100 };
      };

      const hslToHex = ({ h, s, l }) => {
        s /= 100; l /= 100;
        const k = n => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = n => {
          const c = l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
          return Math.round(255 * c).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
      };

      const baseHsl = hexToHsl(philPalette.active);

      const philShadeForIso = (iso) => {
        if (isoColorCache[iso]) return isoColorCache[iso];
        const hash = iso.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
        const hShift = (hash % 24) - 12;
        const lShift = ((hash >> 3) % 18) - 9;
        const sShift = ((hash >> 2) % 14) - 7;
        const tinted = hslToHex({
          h: (baseHsl.h + hShift + 360) % 360,
          s: clamp(baseHsl.s + sShift, 35, 85),
          l: clamp(baseHsl.l + lShift, 42, 78)
        });
        isoColorCache[iso] = tinted;
        return tinted;
      };

      const highlightCondition = () => ['in', ['get', COUNTRY_PROP], ['literal', Array.from(highlighted)]];

      const makeFillColorExpr = () => {
        if (!highlighted.size) return philPalette.neutral;
        const expr = ['match', ['get', COUNTRY_PROP]];
        highlighted.forEach(iso => expr.push(iso, philShadeForIso(iso)));
        expr.push(philPalette.neutral);
        return expr;
      };

      const makeFillOpacityExpr = () => ['case', highlightCondition(), 0.92, 0.32];
      const makeOutlineExpr = () => ['case', highlightCondition(), philPalette.accent, philPalette.border];
      const makeGlowExpr = () => ['case', highlightCondition(), philPalette.glow, 'rgba(0,0,0,0)'];

      function refreshStyling() {
        if (!mapReady) return;
        map.setPaintProperty('country-fills', 'fill-color', makeFillColorExpr());
        map.setPaintProperty('country-fills', 'fill-opacity', makeFillOpacityExpr());
        map.setPaintProperty('country-fills', 'fill-outline-color', makeOutlineExpr());
        map.setPaintProperty('country-glow', 'line-color', makeGlowExpr());
      }

      function labelForIso(iso) {
        return countryLookup[iso]?.name || fallbackNames[iso] || iso;
      }

      function updateHoverReadout(label) {
        hoverReadoutEl.textContent = label || 'Tap a country';
      }

      function renderSelectionList() {
        selectionListEl.innerHTML = '';
        if (!highlighted.size) {
          const li = document.createElement('li');
          li.className = 'empty-state';
          li.textContent = 'Click countries to select.';
          selectionListEl.appendChild(li);
          return;
        }
        Array.from(highlighted)
          .map(iso => ({ iso, name: labelForIso(iso) }))
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach(({ iso, name }) => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${name}</strong><span>${iso}</span>`;
            selectionListEl.appendChild(li);
          });
      }

      function hideSuggestions() {
        suggestionsEl.style.display = 'none';
        suggestionsEl.innerHTML = '';
        currentSuggestions = [];
      }

      function showSuggestions(matches) {
        if (!matches.length) { hideSuggestions(); return; }
        suggestionsEl.style.display = 'block';
        suggestionsEl.innerHTML = '';
        matches.slice(0, 6).forEach(meta => {
          const div = document.createElement('div');
          div.className = 'suggestion';
          div.textContent = meta.name;
          div.addEventListener('click', () => selectFromSearch(meta));
          suggestionsEl.appendChild(div);
        });
      }

      function selectFromSearch(meta) {
        hideSuggestions();
        searchInputEl.value = '';
        if (!highlighted.has(meta.iso3)) highlighted.add(meta.iso3);
        refreshStyling();
        renderSelectionList();
        if (meta.center) {
          map.flyTo({ center: meta.center, zoom: 4, speed: 0.9, curve: 1.4, essential: true });
        }
      }

      function handleSearchInput(e) {
        const q = e.target.value.trim().toLowerCase();
        if (!q) { hideSuggestions(); return; }
        currentSuggestions = countryDirectory.filter(m => m.searchKey.includes(q));
        showSuggestions(currentSuggestions);
      }

      async function hydrateCountryDirectory() {
        try {
          const res = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2,cca3,latlng');
          const data = await res.json();
          countryDirectory = data
            .filter(e => e.cca3)
            .map(e => {
              const ll = Array.isArray(e.latlng) && e.latlng.length === 2 ? e.latlng : [0, 0];
              const meta = {
                name: e.name?.common || e.cca3,
                iso3: e.cca3,
                iso2: e.cca2 || '',
                center: [ll[1], ll[0]],
                searchKey: (e.name?.common || e.cca3).toLowerCase()
              };
              countryLookup[meta.iso3] = meta;
              return meta;
            })
            .sort((a, b) => a.name.localeCompare(b.name));
          searchInputEl.disabled = false;
          searchInputEl.placeholder = 'Search country...';
          renderSelectionList();
        } catch (err) {
          console.warn('Country directory failed', err);
        }
      }

      function setPanelCollapsed(collapsed) {
        panelCollapsed = collapsed;
        panelEl.classList.toggle('collapsed', collapsed);
        panelToggleEl.setAttribute('aria-expanded', (!collapsed).toString());
        panelToggleEl.querySelector('.toggle-label').textContent = collapsed ? 'Show tools' : 'Hide tools';
      }

      function syncPanelMode() {
        if (mobileMedia.matches) setPanelCollapsed(true);
        else setPanelCollapsed(false);
      }

      document.addEventListener('click', e => {
        if (!e.target.closest('.search-block')) hideSuggestions();
      });

      searchInputEl.disabled = true;
      searchInputEl.placeholder = 'Loading...';
      searchInputEl.addEventListener('input', handleSearchInput);
      searchInputEl.addEventListener('keydown', e => {
        if (e.key === 'Enter' && currentSuggestions.length) selectFromSearch(currentSuggestions[0]);
      });

      panelToggleEl.addEventListener('click', () => setPanelCollapsed(!panelCollapsed));
      mobileMedia.addEventListener('change', syncPanelMode);
      syncPanelMode();
      renderSelectionList();
      hydrateCountryDirectory();

      function polishLabels() {
        (map.getStyle().layers || []).forEach(layer => {
          if (layer.type !== 'symbol' || !layer.layout?.['text-field']) return;
          map.setPaintProperty(layer.id, 'text-color', '#cdd6f4');
          map.setPaintProperty(layer.id, 'text-halo-color', 'rgba(0,0,0,0)');
          map.setPaintProperty(layer.id, 'text-halo-width', 0);
          map.setPaintProperty(layer.id, 'text-halo-blur', 0);
        });
      }

      map.on('load', () => {
        mapReady = true;

        map.addSource('countries', {
          type: 'vector',
          url: 'mapbox://mapbox.country-boundaries-v1',
          promoteId: COUNTRY_PROP
        });

        map.addLayer({
          id: 'country-fills',
          type: 'fill',
          source: 'countries',
          'source-layer': 'country_boundaries',
          paint: {
            'fill-color': makeFillColorExpr(),
            'fill-opacity': makeFillOpacityExpr(),
            'fill-outline-color': makeOutlineExpr()
          }
        });

        map.addLayer({
          id: 'country-borders',
          type: 'line',
          source: 'countries',
          'source-layer': 'country_boundaries',
          paint: { 'line-color': '#1e293b', 'line-width': 0.6 }
        });

        map.addLayer({
          id: 'country-glow',
          type: 'line',
          source: 'countries',
          'source-layer': 'country_boundaries',
          paint: {
            'line-color': makeGlowExpr(),
            'line-width': 4,
            'line-blur': 2,
            'line-opacity': 0.35
          }
        });

        map.addLayer({
          id: 'country-hover-outline',
          type: 'line',
          source: 'countries',
          'source-layer': 'country_boundaries',
          paint: {
            'line-color': ['case', ['boolean', ['feature-state', 'hover'], false], '#fde68a', 'rgba(0,0,0,0)'],
            'line-width': 2.5,
            'line-opacity': 0.9
          }
        });

        polishLabels();

        const hoverTarget = { source: 'countries', 'source-layer': 'country_boundaries' };

        function clearHover() {
          if (hoveredIso) {
            map.setFeatureState({ ...hoverTarget, id: hoveredIso }, { hover: false });
            hoveredIso = null;
          }
          map.getCanvas().style.cursor = '';
          updateHoverReadout();
        }

        map.on('click', 'country-fills', e => {
          if (!e.features?.length) return;
          const iso = e.features[0].properties[COUNTRY_PROP];
          if (!iso) return;
          if (e.features[0].properties.name_en) fallbackNames[iso] = e.features[0].properties.name_en;
          if (highlighted.has(iso)) highlighted.delete(iso);
          else highlighted.add(iso);
          refreshStyling();
          renderSelectionList();
        });

        map.on('mousemove', 'country-fills', e => {
          if (!e.features?.length) { clearHover(); return; }
          const iso = e.features[0].properties[COUNTRY_PROP];
          if (!iso) return;
          if (e.features[0].properties.name_en) fallbackNames[iso] = e.features[0].properties.name_en;
          if (hoveredIso && hoveredIso !== iso) {
            map.setFeatureState({ ...hoverTarget, id: hoveredIso }, { hover: false });
          }
          hoveredIso = iso;
          map.setFeatureState({ ...hoverTarget, id: iso }, { hover: true });
          map.getCanvas().style.cursor = 'pointer';
          updateHoverReadout(labelForIso(iso));
        });

        map.on('mouseleave', 'country-fills', clearHover);
      });
    </script>
  </body>
</html>
